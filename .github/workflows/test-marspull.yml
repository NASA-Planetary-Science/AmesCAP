name: Test MarsPull

on:
  push:
    branches: [ devel ]
  pull_request:
    branches: [ devel ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Create virtual environment
      run: |
        python -m venv amescap
        source amescap/bin/activate
        python -m pip install --upgrade pip
    
    - name: Install AmesCAP from GitHub
      run: |
        source amescap/bin/activate
        pip install git+https://github.com/NASA-Planetary-Science/AmesCAP.git@devel
        
    - name: Copy profile file
      run: |
        source amescap/bin/activate
        # Check if profile file exists and copy it
        if [ -f amescap/mars_templates/amescap_profile ]; then
          cp amescap/mars_templates/amescap_profile ~/.amescap_profile
        else
          echo "Profile file not found in expected location, searching..."
          find . -name "amescap_profile" -o -name "amescap-profile" | xargs -I{} cp {} ~/.amescap_profile
        fi
    
    - name: Test MarsPull help message
      run: |
        source amescap/bin/activate
        MarsPull -h
    
    - name: Test MarsPull list functionality
      run: |
        source amescap/bin/activate
        MarsPull -list || echo "List command may require internet access or specific permissions"
    
    - name: Create test script
      run: |
        cat > test_marspull.py << 'EOF'
        import unittest
        import subprocess
        import os
        import sys
        
        class TestMarsPull(unittest.TestCase):
            def test_help_command(self):
                """Test if the help command works"""
                result = subprocess.run(["MarsPull", "-h"], 
                                       capture_output=True, text=True)
                self.assertEqual(result.returncode, 0)
                self.assertIn("Uility for downloading NASA Ames Mars Global Climate", result.stdout)
        
            def test_list_command(self):
                """Test if the list command works - we don't check output as it may vary"""
                result = subprocess.run(["MarsPull", "-list"], 
                                       capture_output=True, text=True)
                # Depending on network access, this might return different codes
                # so we just check that it runs without crashing
                if result.returncode == 0:
                    self.assertIn("Available", result.stdout)
        
            def test_error_on_missing_args(self):
                """Test that an error is raised when directory is specified without ls or filename"""
                result = subprocess.run(["MarsPull", "ACTIVECLDS"], 
                                       capture_output=True, text=True)
                self.assertIn("ERROR No file requested", result.stdout)
        
        if __name__ == '__main__':
            unittest.main()
        EOF
    
    - name: Run tests
      run: |
        source amescap/bin/activate
        python -m unittest test_marspull.py
    
    - name: Check for package integrity
      run: |
        source amescap/bin/activate
        # Check if other expected scripts are installed
        if command -v MarsPlot &> /dev/null; then
          echo "MarsPlot is installed and working"
          MarsPlot -h
        else
          echo "MarsPlot not found, installation may be incomplete"
        fi